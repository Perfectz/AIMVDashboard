<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AIMV Dashboard Home</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg:#0b1220;--panel:#121a2b;--panel2:#17223a;--text:#e7edf8;--muted:#9fb0cd;--line:#26324d;
      --accent:#4da3ff;--good:#31c26b;--warn:#f6c24b;--bad:#ff7070;
    }
    * { box-sizing:border-box; }
    body { margin:0; font-family:Inter,system-ui,sans-serif; background:linear-gradient(180deg,#09101d,#0b1220); color:var(--text); }
    .wrap { max-width:1200px; margin:0 auto; padding:2rem 1.25rem 3rem; }
    .top { display:flex; justify-content:space-between; align-items:end; gap:1rem; margin-bottom:1.5rem; }
    h1 { margin:0; font-size:2rem; }
    .sub { color:var(--muted); margin-top:.35rem; }
    .links { display:flex; gap:.6rem; flex-wrap:wrap; }
    .btn { border:1px solid var(--line); background:var(--panel); color:var(--text); padding:.55rem .8rem; border-radius:.55rem; text-decoration:none; font-size:.92rem; }
    .btn:hover { border-color:var(--accent); }
    .grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(220px,1fr)); gap:1rem; }
    .card { background:var(--panel); border:1px solid var(--line); border-radius:.8rem; padding:1rem; }
    .label { font-size:.82rem; color:var(--muted); text-transform:uppercase; letter-spacing:.04em; }
    .value { font-size:1.8rem; font-weight:700; margin:.35rem 0 .2rem; }
    .split { display:grid; grid-template-columns:2fr 1fr; gap:1rem; margin-top:1rem; }
    .list { display:grid; gap:.55rem; margin-top:.75rem; }
    .item { display:flex; justify-content:space-between; gap:.8rem; align-items:flex-start; padding:.65rem .7rem; border:1px solid var(--line); border-radius:.55rem; background:var(--panel2); }
    .item a { color:#9fd0ff; text-decoration:none; font-size:.9rem; white-space:nowrap; }
    .ok { color:var(--good); }
    .warn { color:var(--warn); }
    .bad { color:var(--bad); }
    .mono { font-family:ui-monospace,SFMono-Regular,Menlo,monospace; }
    @media (max-width:980px){ .split{grid-template-columns:1fr;} }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <div>
        <h1>Project Home</h1>
        <div class="sub" id="projectSummary">Loading project health…</div>
      </div>
      <div class="links">
        <a class="btn" href="index.html">Step 5: Prompts</a>
        <a class="btn" href="storyboard.html">Step 6: Storyboard</a>
        <a class="btn" href="step4.html">Step 4: References</a>
      </div>
    </div>

    <div class="grid">
      <div class="card"><div class="label">Shots total</div><div class="value" id="shotsTotal">0</div></div>
      <div class="card"><div class="label">Shots ready</div><div class="value ok" id="shotsReady">0</div></div>
      <div class="card"><div class="label">Shots blocked</div><div class="value bad" id="shotsBlocked">0</div></div>
      <div class="card"><div class="label">Missing references</div><div class="value warn" id="missingRefs">0</div><div class="sub" id="missingRefsBreakdown"></div></div>
      <div class="card"><div class="label">Missing transcript segments</div><div class="value warn" id="missingTranscript">0</div></div>
      <div class="card"><div class="label">Missing assets (manifest)</div><div class="value warn" id="missingAssets">0</div></div>
      <div class="card"><div class="label">Storyboard coverage</div><div class="value" id="coverage">0%</div><div class="sub" id="coverageMeta">0 / 0 shots with preview image/video</div></div>
    </div>

    <div class="split">
      <section class="card">
        <div class="label">Next Best Actions</div>
        <div id="actions" class="list"></div>
      </section>
      <section class="card">
        <div class="label">Reference gaps by shot</div>
        <div id="shotGaps" class="list"></div>
      </section>
    </div>
  </div>

  <script src="app.js"></script>
  <script>
    async function initHome() {
      const projectId = (localStorage.getItem('activeProject') || 'default');
      const report = await window.AIMVDashboardData.aggregateHomeData(projectId);

      document.getElementById('shotsTotal').textContent = report.shots.total;
      document.getElementById('shotsReady').textContent = report.shots.ready;
      document.getElementById('shotsBlocked').textContent = report.shots.blocked;
      document.getElementById('missingRefs').textContent = report.missingReferences.total;
      document.getElementById('missingRefsBreakdown').textContent = `${report.missingReferences.characters} character · ${report.missingReferences.locations} location`;
      document.getElementById('missingTranscript').textContent = report.missingTranscriptSegments;
      document.getElementById('missingAssets').textContent = report.missingAssets;
      document.getElementById('coverage').textContent = `${report.storyboard.coveragePercent}%`;
      document.getElementById('coverageMeta').textContent = `${report.storyboard.coveredShots} / ${report.shots.total} shots with preview image/video`;
      document.getElementById('projectSummary').textContent = `${report.projectId} · ${report.nextBestActions.length} prioritized action${report.nextBestActions.length === 1 ? '' : 's'}`;

      const actionsRoot = document.getElementById('actions');
      actionsRoot.innerHTML = report.nextBestActions.length
        ? report.nextBestActions.map(action => `<div class="item"><span>${action.text}</span><a href="${action.href}">Open</a></div>`).join('')
        : '<div class="item"><span class="ok">No urgent actions detected.</span></div>';

      const shotGapsRoot = document.getElementById('shotGaps');
      shotGapsRoot.innerHTML = report.shotReferenceGaps.length
        ? report.shotReferenceGaps.slice(0, 8).map(gap => `<div class="item"><span><span class="mono">${gap.shotId}</span>: ${gap.missing.join(', ')}</span><a href="step4.html?shot=${gap.shotId}">Step 4</a></div>`).join('')
        : '<div class="item"><span class="ok">No missing per-shot references.</span></div>';
    }

    initHome().catch((err) => {
      document.getElementById('projectSummary').textContent = `Unable to load dashboard: ${err.message}`;
    });
  </script>
</body>
</html>
