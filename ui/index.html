<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Step 5: Shots - AI Music Video</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;500;600;700;800&family=Outfit:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="styles.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@shoelace-style/shoelace@2.20.1/cdn/themes/dark.css">
  <link rel="stylesheet" href="ui-layer.css">
</head>
<body>
  <div class="container">
    <div class="main-layout">
      <nav class="left-nav" aria-label="Workflow navigation">
        <div class="nav-brand" data-ui-nav-brand data-ui-mode="standard"></div>

        <div class="project-selector-section" data-ui-project-selector data-ui-mode="standard"></div>

        <div class="nav-divider"></div>

        <div class="nav-stats" data-ui-nav-stats data-ui-mode="standard"></div>

        <div class="nav-divider"></div>

        <div class="nav-header"><div class="nav-title">Workflow Steps</div></div>
        <div class="nav-items" data-ui-workflow-nav data-ui-current="index" data-ui-mode="prompts"></div>

        <div class="nav-divider"></div>
        <div class="nav-header"><div class="nav-title">Resources</div></div>
        <div class="nav-items" data-ui-resource-nav data-ui-current="index" data-ui-mode="prompts"></div>
        <div class="nav-footer" data-ui-nav-footer data-ui-mode="standard"></div>
      </nav>

      <main class="content">
        <div class="page-toolbar">
          <div class="page-toolbar-title">
            <h1 id="pageToolbarHeading">Shot Review</h1>
            <p id="pageToolbarSubtitle">Find a shot, verify its text and references, then generate outputs.</p>
          </div>
          <div class="page-toolbar-actions">
            <button id="mobileNavToggle" class="btn btn-secondary mobile-panel-toggle" type="button">Menu</button>
            <button id="runPipelineBtn" class="btn btn-primary" type="button">Compile &amp; Validate</button>
          </div>
        </div>

        <div class="shot-toolbar">
          <select id="platformFilter" class="search-input">
            <option value="all">All Prompts</option>
            <option value="image">Image Prompts</option>
            <option value="video">Video Prompts</option>
          </select>
          <select id="shotSelector" class="search-input shot-selector">
            <option value="">Select a shot...</option>
          </select>
          <input type="text" id="search" placeholder="Search shots..." class="search-input">
          <select id="lintFilter" class="search-input lint-filter">
            <option value="all">All lint states</option>
            <option value="fail">Failing only</option>
            <option value="pass">Passing only</option>
          </select>
          <button id="toggleShotListBtn" class="btn btn-secondary btn-sm" type="button">Shot List</button>
        </div>

        <div class="shot-list-panel" id="shotListPanel" style="display: none;">
          <div class="shot-list" id="shotList"></div>
        </div>

        <div id="promptsWorkspace">
          <nav class="breadcrumbs" id="breadcrumbs" style="display: none;"></nav>

          <div class="empty-state" id="emptyState" style="display: none;">
          <h2>No Shots Ready Yet</h2>
          <p>Generate shot files, then refresh the index to review them here.</p>
          <p>Before indexing, make sure you have:</p>
          <ul>
            <li>Music is generated</li>
            <li>Shot intents are created</li>
            <li>Canon is filled in (characters, locations)</li>
          </ul>
          <p class="note">Create at least one shot file in <code>prompts/kling/</code>, then run <code>npm run index</code> and select a shot to continue.</p>
          <div class="empty-actions">
            <button id="emptyRunIndex" class="btn btn-primary" title="Refresh the shot index from files">Regenerate Index</button>
            <button id="emptyOpenGuide" class="btn btn-secondary">Open Guide</button>
          </div>
          </div>

          <div class="prompt-viewer" id="promptViewer" style="display: none;">
          <div class="prompt-header">
            <h2 id="promptTitle">Select a Shot</h2>
            <div class="prompt-meta">
              <span id="promptTool" class="tool-badge"></span>
              <span id="promptLintStatus" class="lint-status"></span>
            </div>
          </div>

          <div class="unified-prompt-view" id="unifiedPromptView">
            <div class="prompt-block" id="imagePromptBlock" data-collapse-key="step5-image-prompt">
              <div class="prompt-block-header">
                <span class="prompt-block-label">Image Prompt</span>
                <span class="prompt-block-toggle">&#9660;</span>
              </div>
              <div class="prompt-block-body">
                <div class="prompt-content"><pre id="imagePromptContent"></pre></div>
              </div>
            </div>

            <div class="prompt-block" id="videoPromptBlock" data-collapse-key="step5-video-prompt">
              <div class="prompt-block-header">
                <span class="prompt-block-label">Video Prompt</span>
                <span class="prompt-block-toggle">&#9660;</span>
              </div>
              <div class="prompt-block-body">
                <div class="prompt-content"><pre id="videoPromptContent"></pre></div>
              </div>
            </div>
          </div>

            <div class="prompt-block" data-collapse-key="step5-prompt-info">
              <div class="prompt-block-header">
                <span class="prompt-block-label">File Info</span>
                <span class="prompt-block-toggle">&#9660;</span>
              </div>
              <div class="prompt-block-body">
                <div class="prompt-info">
                  <div class="info-row"><strong>Shot File:</strong> <code id="promptFile"></code></div>
                  <div class="info-row" id="promptVersionRow" style="display: none;"><strong>Version:</strong> <span id="promptVersion"></span></div>
                  <div class="info-row" id="lintErrorsRow" style="display: none;"><strong>Lint Errors:</strong><ul id="lintErrorsList"></ul></div>
                </div>
              </div>
            </div>

          <div class="shot-detail-layout">
            <section class="shot-visual-panel">
              <div class="variation-selector" id="variationSelector" style="display: none;">
                <button class="variation-btn" data-variation="A">Option A</button>
                <button class="variation-btn" data-variation="B">Option B</button>
                <button class="variation-btn" data-variation="C">Option C</button>
                <button class="variation-btn" data-variation="D">Option D</button>
              </div>

              <label class="variation-chosen-check" id="variationChosenLabel" style="display: none;">
                <input type="checkbox" id="variationChosenCheckbox" />
                <span>Mark as chosen variation</span>
              </label>

              <div class="shot-generation-layout" id="shotGenerationLayout" style="display: none;">
                <div class="shot-renders" id="shotRenders" style="display: none;">
                  <div class="shot-renders-header">
                    <h3>Generated Frames</h3>
                  </div>
                  <div class="continuity-note" id="continuityNote"></div>
                  <div class="shot-renders-grid" id="shotRendersGrid"></div>
                  <div class="generation-history collapsible-section" id="generationHistorySection" data-collapse-key="step5-gen-history">
                    <div class="generation-history-header collapsible-section-header">
                      <h4>Generation History</h4>
                      <div style="display:flex;gap:0.5rem;align-items:center;">
                        <button id="refreshGenerationHistoryBtn" class="btn btn-secondary btn-sm">Refresh</button>
                        <span class="prompt-block-toggle">&#9660;</span>
                      </div>
                    </div>
                    <div class="collapsible-section-body">
                      <div id="generationHistoryList" class="generation-history-list"></div>
                    </div>
                  </div>
                </div>
              </div>
            </section>

            <aside class="actions-panel">
              <div class="shot-readiness collapsible-section" id="shotReadiness" data-collapse-key="step5-preflight">
                <div class="shot-readiness-header collapsible-section-header">
                  <strong>Preflight</strong>
                  <div style="display:flex;gap:0.5rem;align-items:center;">
                    <button id="refreshReadinessBtn" class="btn btn-secondary btn-sm" type="button">Refresh</button>
                    <span class="prompt-block-toggle">&#9660;</span>
                  </div>
                </div>
                <div class="collapsible-section-body">
                  <div class="readiness-badges">
                    <span id="readinessReplicate" class="readiness-pill pending">Replicate: unknown</span>
                    <span id="readinessPrompt" class="readiness-pill pending">Prompt: unknown</span>
                    <span id="readinessContinuity" class="readiness-pill pending">Continuity: unknown</span>
                    <span id="readinessRefs" class="readiness-pill pending">References: unknown</span>
                  </div>
                  <div id="readinessMessage" class="readiness-message">Select a shot and run refresh to validate generation readiness.</div>
                </div>
              </div>

              <div class="panel-section-title">Primary Actions</div>
              <div class="prompt-actions">
                <button id="generateShotBtn" class="btn btn-generate" style="display: none;">Generate Shot</button>
                <button id="generationCancelBtn" class="btn btn-secondary" style="display: none;" disabled>Cancel Generation</button>
                <button id="copyBtn" class="btn btn-primary">Copy to Clipboard</button>
                <button id="previewContextBtn" class="btn btn-secondary">Preview AI Context</button>
                <span id="copyFeedback" class="copy-feedback"></span>
              </div>

              <div class="advanced-actions-shell">
                <div class="panel-section-title">Advanced</div>
                <button id="toggleAdvancedActionsBtn" class="btn btn-secondary btn-sm" type="button">Show Advanced</button>
                <div id="advancedActionsPanel" class="advanced-actions-panel" style="display: none;">
                  <button id="generateRefImageBtn" class="btn btn-secondary" style="display: none;">Generate Single Ref Image</button>
                  <button id="replicateKeyBtn" class="btn btn-secondary">Replicate Key</button>
                  <button id="aiProviderBtn" class="btn btn-secondary">AI Settings</button>
                  <button id="agentGeneratePromptBtn" class="btn btn-secondary" style="display: none;">Agent Generate Prompt</button>
                </div>
              </div>

              <div class="reference-selector collapsible-section" id="referenceSelector" data-collapse-key="step5-references" style="display: none;">
                <div class="reference-selector-header collapsible-section-header">
                  <span class="reference-selector-title">Reference Images</span>
                  <div style="display:flex;gap:0.5rem;align-items:center;">
                    <button id="refSelectAllBtn" class="btn btn-secondary btn-xs" type="button">All</button>
                    <button id="refClearAllBtn" class="btn btn-secondary btn-xs" type="button">Clear</button>
                    <span class="prompt-block-toggle">&#9660;</span>
                  </div>
                </div>
                <div class="collapsible-section-body">
                  <div class="reference-selector-count" id="referenceSelectorCount">0 / 13 selected</div>
                  <div class="reference-selector-list" id="referenceSelectorList"></div>
                </div>
              </div>

              <div class="panel-section-title">Status</div>
              <div class="generation-job-row">
                <span id="generationJobStatus" class="generation-job-status"></span>
                <span id="generationMetrics" class="generation-metrics"></span>
              </div>
              <div id="referenceProvenance" class="reference-provenance"></div>
              <div class="pipeline-status-row">
                <span id="pipelineStatus" class="pipeline-status">Pipeline status pending...</span>
              </div>

            </aside>
          </div>

            <div class="step-footer">
              <a href="storyboard.html" class="btn btn-primary">Continue to Step 6: Storyboard</a>
            </div>
          </div>
        </div>

      </main>
    </div>
  </div>

  <div class="mobile-panel-overlay" id="mobilePanelOverlay" aria-hidden="true"></div>

  <div data-ui-new-project-modal></div>
  <div data-ui-analysis-prompt-modal></div>

  <div class="modal" id="replicateKeyModal" style="display: none;">
    <div class="modal-overlay" id="replicateKeyModalOverlay"></div>
    <div class="modal-content">
      <div class="modal-header"><h2>Replicate Session Key</h2><button class="modal-close" id="replicateKeyModalClose">×</button></div>
      <div class="modal-body">
        <p class="modal-description">Set a key for this running server session. This does not edit your <code>.env</code>.</p>
        <div class="form-group">
          <label for="replicateKeyInput">API Token</label>
          <input type="password" id="replicateKeyInput" placeholder="r8_..." autocomplete="off" />
        </div>
        <div class="info-row"><strong>Status:</strong> <span id="replicateKeyStatus">Unknown</span></div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" id="clearReplicateKeyBtn">Clear Session Key</button>
        <button class="btn btn-primary" id="saveReplicateKeyBtn">Save Session Key</button>
      </div>
    </div>
  </div>

  <div class="modal" id="aiProviderModal" style="display: none;">
    <div class="modal-overlay" id="aiProviderModalOverlay"></div>
    <div class="modal-content">
      <div class="modal-header"><h2>AI Provider Settings</h2><button class="modal-close" id="aiProviderModalClose">&times;</button></div>
      <div class="modal-body">
        <p class="modal-description">Select which AI model provider to use for agent runs and page chat.</p>
        <div class="ai-provider-selector">
          <label class="ai-provider-option">
            <input type="radio" name="aiProvider" value="anthropic" />
            <span class="ai-provider-label">Anthropic Claude</span>
            <span class="ai-provider-model" id="aiProviderAnthropicModel"></span>
          </label>
          <label class="ai-provider-option">
            <input type="radio" name="aiProvider" value="openai" />
            <span class="ai-provider-label">OpenAI</span>
            <span class="ai-provider-model" id="aiProviderOpenaiModel"></span>
          </label>
          <label class="ai-provider-option">
            <input type="radio" name="aiProvider" value="github" />
            <span class="ai-provider-label">GitHub Models (OAuth)</span>
            <span class="ai-provider-model" id="aiProviderGithubModel"></span>
          </label>
        </div>

        <div class="ai-provider-key-section" id="aiProviderAnthropicSection">
          <div class="panel-section-title">Anthropic API Key</div>
          <div class="form-group">
            <input type="password" id="anthropicKeyInput" placeholder="sk-ant-..." autocomplete="off" />
          </div>
          <div class="info-row"><strong>Status:</strong> <span id="anthropicKeyStatus">Unknown</span></div>
          <div class="ai-provider-key-actions">
            <button class="btn btn-secondary btn-sm" id="clearAnthropicKeyBtn">Clear</button>
            <button class="btn btn-primary btn-sm" id="saveAnthropicKeyBtn">Save Session Key</button>
          </div>
        </div>

        <div class="ai-provider-key-section" id="aiProviderOpenaiSection">
          <div class="panel-section-title">OpenAI API Key</div>
          <div class="form-group">
            <input type="password" id="openaiKeyInput" placeholder="sk-..." autocomplete="off" />
          </div>
          <div class="info-row"><strong>Status:</strong> <span id="openaiKeyStatus">Unknown</span></div>
          <div class="ai-provider-key-actions">
            <button class="btn btn-secondary btn-sm" id="clearOpenaiKeyBtn">Clear</button>
            <button class="btn btn-primary btn-sm" id="saveOpenaiKeyBtn">Save Session Key</button>
          </div>
        </div>

        <div class="ai-provider-key-section" id="aiProviderGithubSection">
          <div class="panel-section-title">GitHub OAuth</div>
          <div class="info-row"><strong>Status:</strong> <span id="githubProviderStatus">Not connected</span></div>
          <p class="modal-description">GitHub Models uses OAuth. Manage connection via the AI chat window.</p>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-primary" id="aiProviderModalDone">Done</button>
      </div>
    </div>
  </div>

  <div class="modal" id="generationChoiceModal" style="display: none;">
    <div class="modal-overlay" id="generationChoiceModalOverlay"></div>
    <div class="modal-content modal-large">
      <div class="modal-header"><h2>Review Generated Outputs</h2><button class="modal-close" id="generationChoiceModalClose">×</button></div>
      <div class="modal-body">
        <p class="modal-description" id="generationChoiceMeta">Review generated outputs and choose what to keep.</p>
        <div class="shot-renders-grid" id="generationChoiceGrid"></div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-primary" id="quickAcceptGeneratedBtn">Quick Accept (Save First + Last)</button>
        <button class="btn btn-primary" id="quickAcceptAndNextBtn">Quick Accept + Next</button>
        <button class="btn btn-secondary" id="discardGeneratedBtn">Discard All</button>
        <button class="btn btn-secondary" id="closeGenerationChoiceBtn">Close</button>
      </div>
    </div>
  </div>

  <div class="modal" id="generationJobDetailsModal" style="display: none;">
    <div class="modal-overlay" id="generationJobDetailsModalOverlay"></div>
    <div class="modal-content modal-large">
      <div class="modal-header"><h2>Generation Job Details</h2><button class="modal-close" id="generationJobDetailsModalClose">×</button></div>
      <div class="modal-body">
        <p class="modal-description" id="generationJobDetailsMeta">Inspect job payloads and retry with overrides.</p>
        <div class="generation-job-details-grid">
          <div class="generation-job-detail-block">
            <h4>Input</h4>
            <pre id="generationJobInputJson"></pre>
          </div>
          <div class="generation-job-detail-block">
            <h4>Result / References</h4>
            <pre id="generationJobResultJson"></pre>
          </div>
          <div class="generation-job-detail-block">
            <h4>Failure Trace</h4>
            <pre id="generationJobFailureJson"></pre>
          </div>
          <div class="generation-job-detail-block">
            <h4>Recent Events</h4>
            <pre id="generationJobEventsJson"></pre>
          </div>
        </div>
        <div class="generation-retry-form">
          <div class="form-group">
            <label for="generationRetryVariation">Variation</label>
            <select id="generationRetryVariation">
              <option value="">(keep same)</option>
              <option value="A">A</option>
              <option value="B">B</option>
              <option value="C">C</option>
              <option value="D">D</option>
            </select>
          </div>
          <div class="form-group">
            <label for="generationRetryMaxImages">Max Images</label>
            <input type="number" id="generationRetryMaxImages" min="1" max="2" step="1" placeholder="1 or 2" />
          </div>
          <div class="form-group">
            <label for="generationRetryAspectRatio">Aspect Ratio</label>
            <select id="generationRetryAspectRatio">
              <option value="">(keep same)</option>
              <option value="match_input_image">match_input_image</option>
              <option value="16:9">16:9</option>
              <option value="9:16">9:16</option>
              <option value="1:1">1:1</option>
              <option value="4:3">4:3</option>
              <option value="3:4">3:4</option>
            </select>
          </div>
          <div class="form-group">
            <label class="continuity-toggle"><input type="checkbox" id="generationRetryRequireReference" /> <span>Require reference</span></label>
            <label class="continuity-toggle"><input type="checkbox" id="generationRetryPreviewOnly" checked /> <span>Preview only</span></label>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" id="generationJobDetailsCancelBtn">Close</button>
        <button class="btn btn-secondary" id="generationJobRetryDefaultBtn">Retry (Same Settings)</button>
        <button class="btn btn-primary" id="generationJobRetryOverrideBtn">Retry With Overrides</button>
      </div>
    </div>
  </div>

  <div data-ui-toast-container></div>
  <div class="context-drawer-overlay" id="contextDrawerOverlay" style="display:none;"></div>
  <aside class="context-drawer" id="contextDrawer" inert>
    <div class="context-drawer-header">
      <h2>AI Context Preview</h2>
      <button class="btn btn-secondary btn-sm" id="closeContextDrawerBtn">Close</button>
    </div>
    <div class="context-drawer-actions">
      <button class="btn btn-secondary btn-sm" id="copyContextMarkdownBtn">Copy as Markdown</button>
      <button class="btn btn-secondary btn-sm" id="downloadContextJsonBtn">Download JSON Bundle</button>
    </div>
    <div class="context-drawer-content" id="contextDrawerContent"></div>
  </aside>

  <script type="module" src="https://cdn.jsdelivr.net/npm/@shoelace-style/shoelace@2.20.1/cdn/shoelace-autoloader.js"></script>
  <script src="modules/project-context.js"></script>
  <script src="modules/project-actions.js"></script>
  <script src="ui-layer.js"></script>
  <script>window.UILayer && window.UILayer.init();</script>
  <script src="modules/command-palette.js"></script>
  <script src="modules/state.js"></script>
  <script src="modules/shot-flow-state.js"></script>
  <script src="modules/error-taxonomy.js"></script>
  <script src="domain/content-domain.js"></script>
  <script src="domain/reference-upload-domain.js"></script>
  <script src="services/http-client.js"></script>
  <script src="services/service-base.js"></script>
  <script src="services/bootstrap-service.js"></script>
  <script src="services/generation-jobs-service.js"></script>
  <script src="services/generation-readiness-service.js"></script>
  <script src="services/context-bundle-service.js"></script>
  <script src="services/agent-runtime-service.js"></script>
  <script src="services/pipeline-service.js"></script>
  <script src="services/lint-report-service.js"></script>
  <script src="services/auto-save-service.js"></script>
  <script src="services/page-chat-service.js"></script>
  <script src="services/content-service.js"></script>
  <script src="services/project-service.js"></script>
  <script src="services/reference-upload-service.js"></script>
  <script src="services/reference-library-service.js"></script>
  <script src="services/review-service.js"></script>
  <script src="features/content-feature.js"></script>
  <script src="features/project-feature.js"></script>
  <script src="features/reference-feature.js"></script>
  <script src="controllers/app-deps.js"></script>
  <script src="modules/pipeline.js"></script>
  <script src="modules/shared-utils.js"></script>
  <script src="modules/prompt-viewer.js"></script>
  <script src="modules/generation-workflow.js"></script>
  <script src="modules/agent-integration.js"></script>
  <script src="modules/reference-manager.js"></script>
  <script src="modules/canon-editor.js"></script>
  <script src="app.js"></script>
  <script src="modules/page-chat-adapters.js"></script>
  <script src="modules/page-chat.js"></script>
</body>
</html>









